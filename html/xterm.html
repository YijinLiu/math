<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">

        <link href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css"
              rel="stylesheet">

        <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js">
        </script>
        <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-clipboard@0.1.0/lib/addon-clipboard.min.js">
        </script>
        <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/lib/addon-web-links.min.js">
        </script>
        <script id="MathJax-script" async
                src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
        </script>
    </head>
    <body>
        <div id="terminal" style="height:-webkit-fill-available"></div>
        <script>
            window.MathJax = {
                tex: {
                    inlineMath: [['$', '$'], ['\\(', '\\)']]
                }
            };

            const socketProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const socketUrl = `${socketProtocol}//${window.location.host}/ws`;
            let socket;

            const term = new Terminal({
                cursorBlink: true,
                fontFamily: 'Monospace',
                fontSize: 16,
                lineHeight: 1.1
            });
            term.loadAddon(new ClipboardAddon.ClipboardAddon());
            term.loadAddon(new WebLinksAddon.WebLinksAddon());
            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.open(document.getElementById('terminal'));
            term.prompt = () => socket.send('\n');
            term.onKey(keyObj => socket.send(keyObj.key));

            term.onResize((size) => {
                const msg = {command: 'resize', cols: size.cols, rows: size.rows};
                const enc = new TextEncoder();
                socket.send(enc.encode(JSON.stringify(msg)));
            });
            window.addEventListener('resize', (evt) => {
                fitAddon.fit();
            }, false);

            let typesetTimeout = 0;
            function connect() {
                console.log('Connecting to ', socketUrl);
                socket = new WebSocket(socketUrl);
                socket.onopen = (evt) => {
                    console.log('Connected.');
                    fitAddon.fit();
                };
                socket.onmessage = (evt) => {
                    //console.log('Received', evt.data);
                    term.write(evt.data);
                    if (typesetTimeout) clearTimeout(typesetTimeout);
                    typesetTimeout = setTimeout(() => {
                        MathJax.typesetPromise();
                        typesetTimeout = 0;
                    }, 1000);
                };
                socket.onclose = (evt) => {
                    console.log('Disconnected. Will reconnect in a second.');
                    setTimeout(connect, 1000);
                };
                socket.onerror = (evt) => {
                    console.log('Error. Will reconnect in 3 seconds.');
                    setTimeout(connect, 3000);
                };
            }
            connect();
        </script>
    </body>
</html>
